# /srv/mosdns/config.yaml
log:
  level: info

plugins:

  # 自定义hosts
  - tag: hosts
    type: hosts
    args:
      files:
        - "./rules/hosts.txt"

  # has_resp插件,用于简化配置文件
  - tag: has_resp_sequence
    type: sequence
    args:
      - matches:
          - has_resp
        exec: accept

  # 缓存
  - tag: custom_cache
    type: cache
    args:
      size: 10240
      lazy_cache_ttl: 259200
      dump_file: ./cache.dump
      dump_interval: 3600

  # 转发至本地服务器
  - tag: forward_local
    type: forward
    args:
      concurrent: 3
      upstreams:
        - tag: dnspod_main
          addr: "https://1.12.12.12/dns-query"
        - tag: alidns_main
          addr: "https://223.5.5.5/dns-query"
        - tag: alidns_backup
          addr: "https://223.6.6.6/dns-query"
  # 转发至远程服务器 Clash
  - tag: forward_remote
    type: forward
    args:
      concurrent: 2
      upstreams:
        - tag: clash_udp
          addr: "127.0.0.1:5352"
        - tag: clash_tcp
          addr: "tcp://127.0.0.1:5352"
          enable_pipeline: true

  # fallback的primary服务器
  - tag: local_ip_sequence
    type: sequence
    args:
      - exec: $forward_local
      - matches: "!resp_ip &./rules/CN-ip-cidr.txt"   # 返回非国内ip则drop_resp
        exec: drop_resp
  # fallback的secondary服务器
  - tag: remote_sequence
    type: sequence
    args:
      - exec: $forward_remote
      - exec: accept
  # fallback服务器
  - tag: fallback_ip
    type: fallback
    args:
      primary: local_ip_sequence
      secondary: remote_sequence
      threshold: 500              # 无响应回滚阈值。单位毫秒。默认 500 。
      always_standby: true        # 副可执行插件始终待命。

  # 主要的运行逻辑插件
  # sequence 插件中调用的插件 tag 必须在 sequence 前定义，
  # 否则 sequence 找不到对应插件。
  - tag: main_sequence
    type: sequence
    args:
      - matches: qtype 12                     # 屏蔽 QTYPE 12
        exec: reject 0

      - matches: qtype 65                     # 屏蔽 QTYPE 65
        exec: reject 0

      - exec: $hosts                          # hosts
      - exec: jump has_resp_sequence

      - matches:
          - qname &./rules/reject-list.txt    # 屏蔽广告
          - qname &./rules/block_list.txt     # 屏蔽黑明单域名
        exec: reject 0

      - matches:
          - qname &./rules/gfw.txt            # gwf域名文件
          - qname &./rules/grey_list.txt      # 用来存放被污染的域名
        exec: $forward_remote                 # GFW域名和污染域名直接请求远程 clash的fakeip
      - exec: jump has_resp_sequence

      - exec: prefer_ipv4                     # 让下游客户端支持双栈时优先使用 IPv4
      - exec: $custom_cache                   # 缓存
      - exec: jump has_resp_sequence

      - matches: 
          - qname &./rules/direct-list.txt    # 国内域名
          - qname &./rules/white_list.txt     # 存放DDNS 和 其他白名单域名
        exec: $forward_local                  # 国内域名请求本地 DNS
      - exec: jump has_resp_sequence

      - exec: $fallback_ip                    # fallback服务器

  # 启动 udp 服务器。
  - tag: udp_server
    type: udp_server
    args:
      entry: main_sequence
      listen: :5351
